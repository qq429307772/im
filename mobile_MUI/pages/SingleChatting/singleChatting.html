<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../common/css/header.css"/>
		<link rel="stylesheet" type="text/css" href="singleChatting.css"/>
		<script src="../../js/mui.min.js"></script>
		<script src="../../download/jQuery/jquery-3.3.1.min.js"></script>
		<script src="../../download/handlebars/handlebars-v4.0.12.js"></script>
		<script src="../../config/TimConfig.js"></script>
		<script src="../../common/js/TimUtil.js"></script>
		<script src="../../config/websocketContant.js"></script>
		<script src="../../common/js/cacheChatHistory.js"></script>
		<script src="../../common/js/cacheChatSnapshot.js"></script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav title-header noshadow">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left title-color title-size-left">消息</a>
		    <h1 id="single-chatting-nickname" class="mui-title title-color"></h1>
		</header>
		<div id="msg-outter" class="mui-content">
			<div id='msg'>
				
			</div>
		</div>
		<footer>
			<div class="footer-center">
				<textarea id='msg-text' type="text" class='input-text'></textarea>
			</div>
			<label for="" class="footer-right">
				<button type="button" class="mui-btn mui-btn-gray send-btn" id="send">发送</button>
			</label>
		</footer>
		<script type="text/javascript">
			/**
			 * 显示好友信息
			 * 设置键盘样式
			 * 滚动调整至底部
			 * 发送消息
			 * 加载本地记录
			 * ！ 判断网络状态
			 * ! 清空消息文本框内容
			 * ！ 缓存本地聊天记录和快照记录
			 */
			mui.init()
			var sideUserId
			var sideNickname
			var sideFaceImageCut
			mui.plusReady(function() {
				var selfWebview = plus.webview.currentWebview()
				var chatlistWebview = plus.webview.getWebviewById('chatlist.html')
				var me = window.TimUtil.getCacheNowUserInfo()
				plus.webview.currentWebview().setStyle({
					softinputMode: "adjustResize"
				})
				sideUserId = selfWebview.userId
				sideNickname = selfWebview.nickname
				sideFaceImageCut = selfWebview.faceImageCut
				document.getElementById('single-chatting-nickname').innerText = sideNickname
				var chatTextDOM = document.getElementById('msg-text')
				refreshChatHistory()
				resizeScreen()
				window.addEventListener('resize', function(){
					resizeScreen()
					document.getElementById('msg-outter').style.paddingBottom = '50px'
				})
				document.getElementById('send').addEventListener('tap', function(e){
					var connectionStatus = plus.networkinfo.getCurrentType()
					if (connectionStatus == 0 || connectionStatus == 1) {
						window.TimUtil.showToast('当前网络状态不可用', 'error')
						return
					}
					var chat_text = chatTextDOM.value					
					if ( chat_text.length === 0 ) {
						return
					}
					sendMsg(me.faceImageCut, chat_text)
					mui.fire(chatlistWebview, window.websocketRequestContant.SingleChatSendMsg, {
						senderId: me.id,
						acceptId: sideUserId,
						content: chat_text
					})
					window.cacheChatHistory.setSingleChatHistory(me.id, sideUserId, chat_text, window.cacheChatHistory.chatHistoryFlagType.contentForMe)
					window.cacheChatSnapshot.setSingleChatSnapshot(me.id, sideUserId, chat_text, window.cacheChatSnapshot.chatSnapshotReadType.YesRead)
					chatTextDOM.value = ''
				})
				window.addEventListener(window.websocketResultContant.AcceptSingleChatMsg, function(e) {
					var content = e.detail.content
					acceptMsg(sideFaceImageCut, content)
					resizeScreen()
				})
			})
			
			function refreshChatHistory() {
				var msgDOM = document.getElementById('msg')
				var me = window.TimUtil.getCacheNowUserInfo()
				var meId = me.id
				var meFaceImageCut = me.faceImageCut
				var chatHistoryList = window.cacheChatHistory.getSingleChatHistory(meId, sideUserId)
				var togetherHTML = ''
				for (var i = 0; i < chatHistoryList.length; i++) {
					var chatHistoryItem = chatHistoryList[i]
					togetherHTML += renderChatHistory(chatHistoryItem, meFaceImageCut)
				}
				msgDOM.innerHTML = togetherHTML
			}
			
			function renderChatHistory(chatHistoryItem, meFaceImageCut) {
				var data = {}
				var msgTemplate
				if (chatHistoryItem.flag == window.cacheChatHistory.chatHistoryFlagType.contentForMe) {
					msgTemplate = $('#msgRightTemplate').html()
					data.avatarPrefix = window.TimConfig.serverImageUrl + window.TimConfig.avatarPrefix
					data.faceImageCut = meFaceImageCut
					data.msg = chatHistoryItem.content
				} else if(chatHistoryItem.flag == window.cacheChatHistory.chatHistoryFlagType.contentForSide) {
					msgTemplate = $('#msgLeftTemplate').html()
					data.avatarPrefix = window.TimConfig.serverImageUrl + window.TimConfig.avatarPrefix
					data.faceImageCut = sideFaceImageCut
					data.msg = chatHistoryItem.content
				}
				var template = Handlebars.compile(msgTemplate)
				var html = template(data)
				return html
			}
			
			function acceptMP3() {
				var audioPlayer = plus.audio.createPlayer('../../common/mp3/qqAccept.mp3')
				audioPlayer.play()
			}
			
			function sendMsg(faceImageCut, msg) {
				var msgRightTemplate = $('#msgRightTemplate').html()
				var template = Handlebars.compile(msgRightTemplate)
				var data = {}
				data.avatarPrefix = window.TimConfig.serverImageUrl + window.TimConfig.avatarPrefix
				data.faceImageCut = faceImageCut
				data.msg = msg
				var html = template(data)
				var msgDOM = document.getElementById('msg')
				msgDOM.insertAdjacentHTML("beforeend", html)
			}
			
			function acceptMsg(faceImageCut, msg) {
				var msgLeftTemplate = $('#msgLeftTemplate').html()
				var template = Handlebars.compile(msgLeftTemplate)
				var data = {}
				data.avatarPrefix = window.TimConfig.serverImageUrl + window.TimConfig.avatarPrefix
				data.faceImageCut = faceImageCut
				data.msg = msg
				var html = template(data)
				var msgDOM = document.getElementById('msg')
				msgDOM.insertAdjacentHTML("beforeend", html)
				acceptMP3()
			}
			
			function resizeScreen() {
				var areaMesContent = document.getElementById('msg')
				areaMesContent.scrollTop = areaMesContent.scrollHeight + areaMesContent.offsetHeight
			}
			function goUserInfo() {
				mui.openWindow({
					url: '../UserInfo/userInfo.html',
					id: 'userInfo.html',
					extras: {
						userId: sideUserId
					}
				})
			}
		</script>
	</body>
	<script type="text/template" id="msgLeftTemplate">
	    <div class="friend_lists">
			<div class="header_img">
				<img src="{{avatarPrefix}}{{faceImageCut}}" width="40px" height="40px" onclick="goUserInfo()"/>
			</div>
			<div class="msg-wrapper right">
				<p class="msg-left-white">{{msg}}</p>
			</div>
		</div>
	</script>
	<script type="text/template" id="msgRightTemplate">
		<div class="me_lists">
			<div class="header_img">
				<img src="{{avatarPrefix}}{{faceImageCut}}" width="40px" height="40px" />
			</div>
			<div class="msg-wrapper left">
				<p class="msg-right-green">{{msg}}</p>
			</div>
		</div>
	</script>
</html>