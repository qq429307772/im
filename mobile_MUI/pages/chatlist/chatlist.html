<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../common/css/header.css"/>
		<link rel="stylesheet" type="text/css" href="../../download/font_icon/iconfont.css"/>
		<link rel="stylesheet" type="text/css" href="chatlist.css"/>
		<link rel="stylesheet" type="text/css" href="singleRequest.css"/>
		<script src="../../js/mui.min.js"></script>
		<script src="../../download/jQuery/jquery-3.3.1.min.js"></script>
		<script src="../../download/handlebars/handlebars-v4.0.12.js"></script>
		<script src="../../config/TimConfig.js"></script>
		<script src="../../common/js/TimUtil.js"></script>
		<script src="../../api/Request/request.js"></script>
		<script src="../../config/websocketContant.js"></script>
		<script src="../../socket/webSocket.js"></script>
		<script src="../../common/js/cacheChatHistory.js"></script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav title-header">
		    <h1 class="mui-title title-color">消息</h1>
		    <a href="#openMenu" class="mui-pull-right mui-icon mui-icon-plusempty" style="color: #fff;font-size: 30px;"></a>
		</header>
		<div class="container">
			<div class="accept-single-request">
				<div id="single-request-list" class="single-request-list">
					
				</div>
			</div>
		</div>
		<div id="openMenu" class="mui-popover">
		  <ul class="mui-table-view">
		    <li class="mui-table-view-cell cell-item" id="addFriend"><a href="#"><span class="iconfont icon-addfriend "></span>加好友</a></li>
		    <li class="mui-table-view-cell cell-item" id="createGroup"><a href="#"><span class="iconfont icon-group"></span>创建群</a></li>
		    <li class="mui-table-view-cell cell-item" id="saoyisao"><a href="#"><span class="iconfont icon-saoyisao"></span>扫一扫</a></li>
		  </ul>
		</div>
		<script type="text/javascript">
			/**
			 * 绑定弹出菜单
			 * 加载后获取未处理的好友请求
			 * 绑定好友请求按钮
			 * 初始化网络连接
			 * 绑定websocket监听
			 * 收到消息将消息通知至指定webview
			 * ! 同意后更新好友列表
			 * ! 收到消息后证明已签收,并缓存本地
			 * ! 同意请求被通过后刷新通讯录
			 * ! 接收新的好友请求刷新请求列表
			 */
			mui.init()
			mui.plusReady(function(){
				window.TimUtil.setSystemStatusColor()
				var user = window.TimUtil.getCacheNowUserInfo()
				var selfWebview = plus.webview.currentWebview()
				var contactWebview = plus.webview.getWebviewById('contact.html')
				refreshAcceptRequest()
				window.TimWebsocket.init()
				selfWebview.addEventListener('show', function() {
					refreshAcceptRequest()
					window.TimWebsocket.init()
				})
				mui('#single-request-list').on('tap', '.agree-button', function(e){
					var sendUserId = this.getAttribute('data-id')
					window.RequestApi.singleRequestAgree({
						meId: user.id,
						sendUserId: sendUserId
					}, function(data) {
						if (data.code == 200) {
							window.TimUtil.showToast('已同意对方的请求', 'success')
							refreshAcceptRequest()
							mui.fire(contactWebview, window.TimConfig.timSubscribe.refreshContactContactListSubscribe)
						} else {
							if (data.code != 200) window.TimUtil.showToast(data.msg, 'error')
						}
					})
				})
				mui('#single-request-list').on('tap', '.refuse-button', function(e){
					var sendUserId = this.getAttribute('data-id')
					window.RequestApi.singleRequestRefuse({
						meId: user.id,
						sendUserId: sendUserId
					}, function(data) {
						if (data.code == 200) {
							window.TimUtil.showToast('已拒绝对方的请求', 'success')
							refreshAcceptRequest()
						} else {
							if (data.code != 200) window.TimUtil.showToast(data.msg, 'error')
						}
					})
				})
				document.getElementById('addFriend').addEventListener('tap', function(){
					mui.openWindow({
						url: '../AddFriend/addFriend.html',
						id: 'addFriend.html',
						show: {autoShow: true, aniShow: 'slide-in-left', duration:100}
					})
				})
				document.getElementById('createGroup').addEventListener('tap', function(){
					console.log('createGroup')
				})
				document.getElementById('saoyisao').addEventListener('tap', function(){
					mui.openWindow({
						url: '../Saoyisao/saoyisao.html',
						id: 'saoyisao.html',
						show: {autoShow: true, aniShow: 'slide-in-top', duration:100},
						createNew: true
					})
				})
				window.addEventListener(window.websocketRequestContant.SingleChatSendMsg, function(e) {
					window.websocketUtil.sendSingleText(e.detail.senderId, e.detail.acceptId, e.detail.content, null)
				})
				window.websocketUtil.subscribe(window.websocketResultContant.AcceptSingleChatMsg,function(result, accepetChatContent){
					var senderId = accepetChatContent.senderId
					var acceptId = accepetChatContent.acceptId
					var content = accepetChatContent.content
					var acceptWebview = plus.webview.getWebviewById('singleChatting_' + senderId)
					if (acceptWebview != null) {
						mui.fire(acceptWebview, window.websocketResultContant.AcceptSingleChatMsg, {content})
					}
					window.websocketUtil.singleSigningMsg(accepetChatContent.contentId, null)
					window.cacheChatHistory.cacheSetSingleChatHistory(acceptId, senderId, content, window.cacheChatHistory.cacheChatHistoryFlagType.contentForSide)
				})
				window.websocketUtil.subscribe(window.websocketResultContant.PullNewContact,function(result, accepetChatContent){
					mui.fire(contactWebview, window.TimConfig.timSubscribe.refreshContactContactListSubscribe)
				})
				window.websocketUtil.subscribe(window.websocketResultContant.PullNewSingleRequest,function(result, accepetChatContent){
					refreshAcceptRequest()
				})
			})
			function refreshAcceptRequest() {
				$('#single-request-list').empty()
				var user = window.TimUtil.getCacheNowUserInfo()
				window.RequestApi.singleRequestAcceptApi({
					userId: user.id
				}, function(data){
					if (data.code == 200) {
						if (data.result.length > 0) {
							renderSingleRequestAcceptHTML(data.result)
						}
					} else {
						window.TimUtil.showToast(data.msg, 'error')
					}
				})
			}
			function renderSingleRequestAcceptHTML(result) {
				var data = {}
				data.result = result
				data.avatarUrlPrefix = window.TimConfig.serverImageUrl + window.TimConfig.avatarPrefix
				var singleRequestTemplate = $('#singleRequestTemplate').html()
				var template = Handlebars.compile(singleRequestTemplate)
				var html = template(data)
				$('#single-request-list').html(html)	
			}
		</script>
		<script type="text/template" id="singleRequestTemplate">
			{{#each result}}
			    <div class="single-request-item" data-id="{{userId}}">
					<div class="item-avatar">
						<img src="{{../avatarUrlPrefix}}{{faceImageCut}}" alt="" />
					</div>
					<div class="item-info">
						<div class="item-info-nickname">{{nickname}}</div>
						<div class="item-info-desc">请求添加你为好友</div>
					</div>
					<div class="item-button-group">
						<button class="agree-button" data-id="{{userId}}">同意</button>
						<button class="refuse-button" data-id="{{userId}}">拒绝</button>
					</div>
				</div>
			{{/each}}
		</script>
	</body>

</html>